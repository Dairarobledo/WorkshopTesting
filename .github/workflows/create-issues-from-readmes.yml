name: Create issues from files (tickets + labs)

on:
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure base labels exist
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          gh label create ticket --description "Bug ticket / incidencia" --color "d73a4a" --force
          gh label create lab --description "Practice lab / ejercicio" --color "0075ca" --force
          gh label create junit --description "JUnit related" --color "1d76db" --force
          gh label create mockito --description "Mockito related" --color "0e8a16" --force

      - name: Create issues from markdown files
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -e

          python3 - <<'PY'
          import os, re, json, subprocess
          from pathlib import Path

          REPO = os.environ["REPO"]
          BASE = Path(".github/issue-templates-data")

          def run(cmd):
            r = subprocess.run(cmd, text=True, capture_output=True)
            if r.returncode != 0:
              raise RuntimeError(f"Command failed: {cmd}\n{r.stderr}")
            return r.stdout.strip()

          def issue_exists(title: str) -> bool:
            q = f'repo:{REPO} type:issue in:title "{title}"'
            out = run(["gh","api","-H","Accept: application/vnd.github+json", f"/search/issues?q={q}"])
            data = json.loads(out)
            return data.get("total_count", 0) > 0

          def parse_frontmatter(md: str):
            # Espera:
            # ---
            # title: "..."
            # labels: ["a","b"]
            # ---
            if not md.startswith("---"):
              raise ValueError("Missing frontmatter (--- ... ---)")

            m = re.search(r"^---\s*\n(.*?)\n---\s*\n(.*)$", md, flags=re.S)
            if not m:
              raise ValueError("Invalid frontmatter block")

            fm, body = m.group(1), m.group(2)
            title_m = re.search(r'^\s*title:\s*"(.*)"\s*$', fm, flags=re.M)
            labels_m = re.search(r'^\s*labels:\s*\[(.*)\]\s*$', fm, flags=re.M)

            if not title_m:
              raise ValueError("Frontmatter missing title")
            title = title_m.group(1).strip()

            labels = []
            if labels_m:
              raw = labels_m.group(1).strip()
              if raw:
                labels = [x.strip().strip('"').strip("'") for x in raw.split(",") if x.strip()]

            return title, labels, body.strip()

          def create_issue(title: str, labels, body: str):
            if issue_exists(title):
              print(f"SKIP (exists): {title}")
              return

            args = ["gh","api","-H","Accept: application/vnd.github+json",
                    f"/repos/{REPO}/issues",
                    "-f", f"title={title}",
                    "-f", f"body={body}"]
            for lab in labels:
              args += ["-f", f"labels[]={lab}"]

            run(args)
            print(f"CREATED: {title}")

          if not BASE.exists():
            print(f"WARNING: {BASE} does not exist. Nothing to do.")
            raise SystemExit(0)

          files = sorted(BASE.rglob("*.md"))
          if not files:
            print("No issue files found.")
            raise SystemExit(0)

          for f in files:
            md = f.read_text(encoding="utf-8")
            title, labels, body = parse_frontmatter(md)

            # Si alguien no pone labels, inferimos por carpeta
            if not labels:
              if "tickets" in f.parts:
                labels = ["ticket"]
              elif "labs" in f.parts:
                labels = ["lab"]

            create_issue(title, labels, body)

          print("Done.")
          PY